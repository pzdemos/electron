<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>客服工作台</title>
    <script src="https://cdn.shushubuyue.net/ajax/libs/tailwindcss/3.4.16/tailwind.min.js"></script>
  </head>
  <body class="h-screen w-screen overflow-hidden bg-slate-950 text-slate-100">
    <main class="relative h-screen w-screen">
      <section class="h-full w-full bg-slate-950">
        <webview
          id="support-webview"
          src="http://localhost:9000/kefu/agent/"
          class="h-full w-full"
          preload="./webview-preload.js"
        ></webview>
      </section>
      <div class="pointer-events-none absolute left-4 top-4 z-10 flex gap-1.5 rounded-full border border-slate-800/70 bg-slate-950/70 p-1 shadow-lg backdrop-blur">
        <button
          id="refresh-btn"
          class="pointer-events-auto rounded-full border border-slate-700/70 bg-slate-900/60 px-2.5 py-1 text-[11px] font-medium text-slate-200 transition hover:border-indigo-400/60 hover:bg-slate-800/70 hover:text-white"
          title="刷新"
        >
          刷新
        </button>
        <button
          id="settings-btn"
          class="pointer-events-auto rounded-full bg-indigo-500/80 px-2.5 py-1 text-[11px] font-semibold text-white transition hover:bg-indigo-400/80"
          title="设置"
        >
          设置
        </button>
      </div>
      <div
        id="settings-modal"
        class="pointer-events-none fixed inset-0 flex items-center justify-center bg-black/60 opacity-0 transition"
      >
        <div class="pointer-events-auto w-full max-w-lg rounded-2xl border border-slate-800 bg-slate-900 p-6 text-left">
          <h2 class="text-base font-semibold text-white">设置 Webview 地址</h2>
          <p class="mt-1 text-xs text-slate-400">支持本地或线上地址，例如 http://localhost:9000/kefu/agent/</p>
          <p class="mt-2 text-xs text-slate-500">
            当前地址：<span id="current-url" class="text-slate-300"></span>
          </p>
          <input
            id="url-input"
            type="text"
            class="mt-4 w-full rounded-xl border border-slate-700 bg-slate-950 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none"
            placeholder="输入目标地址"
          />
          <div class="mt-5 flex justify-end gap-2">
            <button
              id="cancel-btn"
              class="rounded-full border border-slate-700 px-4 py-2 text-xs text-slate-200 transition hover:border-slate-500"
            >
              取消
            </button>
            <button
              id="save-btn"
              class="rounded-full bg-indigo-500 px-4 py-2 text-xs font-semibold text-white transition hover:bg-indigo-400"
            >
              保存并刷新
            </button>
          </div>
        </div>
      </div>
    </main>
    <script>
      const supportWebview = document.getElementById("support-webview");
      const refreshBtn = document.getElementById("refresh-btn");
      const settingsBtn = document.getElementById("settings-btn");
      const settingsModal = document.getElementById("settings-modal");
      const urlInput = document.getElementById("url-input");
      const cancelBtn = document.getElementById("cancel-btn");
      const saveBtn = document.getElementById("save-btn");
      const currentUrl = document.getElementById("current-url");
      const urlStorageKey = "supportWebviewUrl";
      const defaultUrl = "http://localhost:9000/kefu/agent/";

      const updateCurrentUrl = (url) => {
        currentUrl.textContent = url;
      };

      const applyUrl = (url) => {
        const finalUrl = url && url.trim() ? url.trim() : defaultUrl;
        supportWebview.setAttribute("src", finalUrl);
        localStorage.setItem(urlStorageKey, finalUrl);
        updateCurrentUrl(finalUrl);
      };

      const openModal = () => {
        const current = localStorage.getItem(urlStorageKey) || defaultUrl;
        urlInput.value = current;
        settingsModal.classList.remove("opacity-0");
        settingsModal.classList.remove("pointer-events-none");
      };

      const closeModal = () => {
        settingsModal.classList.add("opacity-0");
        settingsModal.classList.add("pointer-events-none");
      };

      applyUrl(localStorage.getItem(urlStorageKey) || defaultUrl);

      refreshBtn.addEventListener("click", () => {
        supportWebview.reload();
      });

      settingsBtn.addEventListener("click", () => {
        openModal();
      });

      cancelBtn.addEventListener("click", () => {
        closeModal();
      });

      saveBtn.addEventListener("click", () => {
        applyUrl(urlInput.value);
        supportWebview.reload();
        closeModal();
      });
      supportWebview?.addEventListener("ipc-message", (event) => {
        if (event.channel === "toast") {
          window.electronAPI?.notifyTest?.(event.args?.[0]);
        }
      });
      if (window.electronAPI?.onOpenSession) {
        window.electronAPI.onOpenSession((sessionId) => {
          if (sessionId) {
            supportWebview?.send("open-session", sessionId);
          }
        });
      }
    </script>
  </body>
</html>
