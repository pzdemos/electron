<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toast</title>
    <script src="https://cdn.shushubuyue.net/ajax/libs/tailwindcss/3.4.16/tailwind.min.js"></script>
  </head>
  <body class="bg-transparent overflow-hidden">
    <div class="flex h-screen items-end justify-end p-4">
      <div class="flex w-full max-w-xs flex-col overflow-hidden rounded-xl border border-slate-200 bg-white text-sm text-slate-700 shadow-xl">
        <div class="flex items-center justify-between bg-blue-500 px-4 py-2 text-white">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold">新消息提醒</span>
            <span id="unread-count" class="rounded-full bg-white/20 px-2 py-0.5 text-xs">0</span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button
              id="toast-toggle"
              class="flex h-6 w-6 items-center justify-center rounded-full text-white transition hover:bg-white/20"
              title="收起/展开"
            >
              <span id="toggle-icon">▾</span>
            </button>
            <button
              id="toast-close"
              class="flex h-6 w-6 items-center justify-center rounded-full text-white transition hover:bg-white/20"
              title="关闭"
            >
              ✕
            </button>
          </div>
        </div>
        <div
          id="toast-list"
          class="max-h-80 min-h-0 flex-1 divide-y divide-slate-200 overflow-y-auto"
        ></div>
        <div id="toast-empty" class="px-4 py-6 text-center text-xs text-slate-400">
          暂无新消息
        </div>
      </div>
    </div>
    <script>
      const closeBtn = document.getElementById("toast-close");
      const toggleBtn = document.getElementById("toast-toggle");
      const toggleIcon = document.getElementById("toggle-icon");
      const toastList = document.getElementById("toast-list");
      const toastEmpty = document.getElementById("toast-empty");
      const unreadCount = document.getElementById("unread-count");
      const pageSize = 6;
      let currentItems = [];
      let currentPage = 1;
      let isExpanded = true;

      const renderList = () => {
        toastList.innerHTML = "";
        const visibleItems = currentItems.slice(0, currentPage * pageSize);
        if (visibleItems.length === 0) {
          if (isExpanded) {
            toastEmpty.classList.remove("hidden");
          }
          return;
        }
        toastEmpty.classList.add("hidden");
        visibleItems.forEach((item) => {
          const row = document.createElement("div");
          row.className = "flex items-start gap-3 px-4 py-3";
          row.dataset.sessionId = item.sessionId || "";
          row.classList.add("cursor-pointer");

          const badge = document.createElement("div");
          badge.className = "flex h-10 w-10 items-center justify-center rounded-full bg-blue-50 text-xs font-semibold text-blue-600";
          badge.textContent = item.time || "现在";

          const content = document.createElement("div");
          content.className = "min-w-0 flex-1";

          const header = document.createElement("div");
          header.className = "flex items-center justify-between gap-2";

          const title = document.createElement("span");
          title.className = "truncate text-sm font-semibold text-slate-800";
          title.textContent = item.title || "新消息";

          const time = document.createElement("span");
          time.className = "text-xs text-slate-400";
          time.textContent = item.time || "";

          const body = document.createElement("p");
          body.className = "mt-1 truncate text-xs text-slate-600";
          body.textContent = item.body || "";

          header.appendChild(title);
          header.appendChild(time);
          content.appendChild(header);
          content.appendChild(body);
          row.appendChild(badge);
          row.appendChild(content);
          toastList.appendChild(row);
        });
      };

      if (window.electronAPI?.onToastList) {
        window.electronAPI.onToastList((payload) => {
          const items = Array.isArray(payload) ? payload : payload?.items || [];
          currentItems = items;
          currentPage = 1;
          unreadCount.textContent = String(payload?.unreadCount || items.length);
          renderList();
        });
      }

      if (window.electronAPI?.onToastExpanded) {
        window.electronAPI.onToastExpanded((expanded) => {
          isExpanded = expanded;
          toggleIcon.textContent = expanded ? "▾" : "▴";
          if (expanded) {
            toastList.classList.remove("hidden");
            renderList();
          } else {
            toastList.classList.add("hidden");
            toastEmpty.classList.add("hidden");
          }
        });
      }

      closeBtn.addEventListener("click", () => {
        window.electronAPI?.toastClose?.();
      });

      toggleBtn.addEventListener("click", () => {
        window.electronAPI?.toastToggle?.();
      });

      toastList.addEventListener("click", (event) => {
        const row = event.target.closest("[data-session-id]");
        if (!row) {
          return;
        }
        const sessionId = row.dataset.sessionId;
        if (sessionId) {
          window.electronAPI?.toastOpenSession?.(sessionId);
        }
      });

      toastList.addEventListener("scroll", () => {
        if (toastList.scrollTop + toastList.clientHeight >= toastList.scrollHeight - 10) {
          const maxPage = Math.ceil(currentItems.length / pageSize);
          if (currentPage < maxPage) {
            currentPage += 1;
            renderList();
          }
        }
      });
    </script>
  </body>
</html>
